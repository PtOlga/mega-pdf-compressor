<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>MEGA PDF Compressor</title>
  <style>
    body { font-family: sans-serif; max-width: 700px; margin: 40px auto; padding: 0 20px; }
    .btn { background: #00a651; color: white; border: none; padding: 12px 24px; font-size: 16px; border-radius: 6px; cursor: pointer; margin: 10px 0; }
    .btn:disabled { background: #ccc; }
    .status { background: #f5f5f5; padding: 16px; border-radius: 6px; margin: 20px 0; white-space: pre-wrap; }
    .hidden { display: none; }
  </style>
</head>
<body>

<h1>üì¶ MEGA PDF Compressor (–±–µ—Å–ø–ª–∞—Ç–Ω–æ)</h1>
<p>–í—ã–±–µ—Ä–∏—Ç–µ PDF –∏–∑ –≤–∞—à–µ–≥–æ MEGA ‚Üí —Å–æ–∂–º–∏—Ç–µ –µ–≥–æ ‚Üí —Å–∫–∞—á–∞–π—Ç–µ –∏–ª–∏ —Å–æ—Ö—Ä–∞–Ω–∏—Ç–µ –æ–±—Ä–∞—Ç–Ω–æ.</p>

<button id="loginBtn" class="btn">üîê –í–æ–π—Ç–∏ –≤ MEGA –∏ –≤—ã–±—Ä–∞—Ç—å PDF</button>
<div id="status" class="status hidden"></div>
<button id="compressBtn" class="btn hidden" disabled>üì§ –°–∂–∞—Ç—å</button>

<script src="https://mega.nz/sdk/v4/sdk.js"></script>
<script>
  const statusEl = document.getElementById('status');
  const loginBtn = document.getElementById('loginBtn');
  const compressBtn = document.getElementById('compressBtn');
  let selectedFileHandle = null;

  mega.initialize({});

  loginBtn.onclick = async () => {
    try {
      statusEl.textContent = '–û—Ç–∫—Ä—ã–≤–∞–µ–º MEGA...';
      statusEl.classList.remove('hidden');

      const file = await mega.selectFile({ extensions: ['pdf'], multiple: false });
      selectedFileHandle = file;

      const sizeMB = (file.size / 1024 / 1024).toFixed(2);
      statusEl.innerHTML = `‚úÖ –í—ã–±—Ä–∞–Ω: <b>${file.name}</b> (${sizeMB} –ú–ë)\n–ì–æ—Ç–æ–≤ –∫ —Å–∂–∞—Ç–∏—é.`;
      compressBtn.classList.remove('hidden');
      compressBtn.disabled = false;
    } catch (e) {
      statusEl.textContent = `‚ùå ${e.message || '–û—Ç–º–µ–Ω–µ–Ω–æ'}`;
    }
  };

  compressBtn.onclick = async () => {
    if (!selectedFileHandle) return;
    compressBtn.disabled = true;
    statusEl.textContent = '–°–∫–∞—á–∏–≤–∞–µ–º —Ñ–∞–π–ª –∏–∑ MEGA...';

    try {
      const arrayBuffer = await selectedFileHandle.read();
      const blob = new Blob([arrayBuffer], { type: 'application/pdf' });
      const originalSizeMB = (blob.size / 1024 / 1024).toFixed(2);

      // ‚ö†Ô∏è –ó–ê–ú–ï–ù–ò–¢–ï –≠–¢–£ –°–°–´–õ–ö–£ –Ω–∞ –≤–∞—à Railway URL –ø–æ—Å–ª–µ —Ä–∞–∑–≤—ë—Ä—Ç—ã–≤–∞–Ω–∏—è!
      const backendUrl = 'https://–≤–∞—à-–±—ç–∫–µ–Ω–¥.up.railway.app/compress';

      const formData = new FormData();
      formData.append('file', blob, selectedFileHandle.name);
      formData.append('level', 'recommended'); // low, recommended, extreme

      statusEl.textContent = `–°–∂–∏–º–∞–µ–º —á–µ—Ä–µ–∑ iLovePDF (${originalSizeMB} –ú–ë)...`;
      const res = await fetch(backendUrl, { method: 'POST', body: formData });

      if (!res.ok) {
        const errorData = await res.json();
        throw new Error(errorData.error || `HTTP ${res.status}`);
      }

      const compressedBlob = await res.blob();
      const compressedSizeMB = (compressedBlob.size / 1024 / 1024).toFixed(2);

      // –ü–æ–ª—É—á–∞–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ —Å–∂–∞—Ç–∏–∏ –∏–∑ –∑–∞–≥–æ–ª–æ–≤–∫–æ–≤
      const reduction = res.headers.get('X-Reduction-Percent') || '?';

      const url = URL.createObjectURL(compressedBlob);

      statusEl.innerHTML = `‚úÖ –ì–æ—Ç–æ–≤–æ! ${originalSizeMB} –ú–ë ‚Üí ${compressedSizeMB} –ú–ë (‚àí${reduction}%)<br>` +
        `<a href="${url}" download="[–°–∂–∞—Ç–æ] ${selectedFileHandle.name}">üì• –°–∫–∞—á–∞—Ç—å</a>`;

      // –ö–Ω–æ–ø–∫–∞ "–°–æ—Ö—Ä–∞–Ω–∏—Ç—å –≤ MEGA"
      const saveBtn = document.createElement('button');
      saveBtn.className = 'btn';
      saveBtn.textContent = 'üíæ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å –≤ MEGA';
      saveBtn.onclick = async () => {
        statusEl.textContent = '–ó–∞–≥—Ä—É–∂–∞–µ–º –≤ MEGA...';
        try {
          await mega.upload({
            name: '[–°–∂–∞—Ç–æ] ' + selectedFileHandle.name,
            content: compressedBlob,
            target: '///'
          });
          statusEl.innerHTML = 'üéâ –°–æ—Ö—Ä–∞–Ω–µ–Ω–æ –≤ –∫–æ—Ä–Ω–µ–≤—É—é –ø–∞–ø–∫—É MEGA!';
        } catch (e) {
          statusEl.textContent = `‚ùå –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏: ${e.message}`;
        }
      };
      document.body.appendChild(saveBtn);

    } catch (e) {
      statusEl.textContent = `‚ùå ${e.message}`;
      compressBtn.disabled = false;
    }
  };
</script>

</body>
</html>