<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>MEGA PDF Compressor</title>
  <style>
    body { font-family: sans-serif; max-width: 700px; margin: 40px auto; padding: 0 20px; }
    .btn { background: #00a651; color: white; border: none; padding: 12px 24px; font-size: 16px; border-radius: 6px; cursor: pointer; margin: 10px 0; }
    .btn:disabled { background: #ccc; }
    .status { background: #f5f5f5; padding: 16px; border-radius: 6px; margin: 20px 0; white-space: pre-wrap; }
    .hidden { display: none; }
    .input {
      width: 100%;
      max-width: 400px;
      padding: 12px;
      margin: 10px 0;
      border: 2px solid #ddd;
      border-radius: 8px;
      font-size: 16px;
    }
    #loginForm, #folderSelector, #fileSelector, #targetFolderSelector {
      margin: 20px 0;
    }
    h3 {
      color: #00a651;
      margin-top: 20px;
    }
  </style>
</head>
<body>

<h1>üì¶ MEGA PDF Compressor (–±–µ—Å–ø–ª–∞—Ç–Ω–æ)</h1>
<p>–í–æ–π–¥–∏—Ç–µ –≤ MEGA ‚Üí –≤—ã–±–µ—Ä–∏—Ç–µ PDF ‚Üí —Å–æ–∂–º–∏—Ç–µ ‚Üí —Å–æ—Ö—Ä–∞–Ω–∏—Ç–µ –æ–±—Ä–∞—Ç–Ω–æ –≤ MEGA.</p>

<div id="loginForm">
  <input type="email" id="emailInput" placeholder="Email –æ—Ç MEGA" class="input">
  <input type="password" id="passwordInput" placeholder="–ü–∞—Ä–æ–ª—å –æ—Ç MEGA" class="input">
  <button id="loginBtn" class="btn">üîê –í–æ–π—Ç–∏ –≤ MEGA</button>
  <p style="font-size: 12px; color: #666; margin-top: 10px;">
    ‚ö†Ô∏è –í–∞—à –ø–∞—Ä–æ–ª—å –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç—Å—è —Ç–æ–ª—å–∫–æ –≤ –±—Ä–∞—É–∑–µ—Ä–µ –∏ –Ω–µ –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç—Å—è –Ω–∞ —Å–µ—Ä–≤–µ—Ä
  </p>
</div>

<div id="folderSelector" class="hidden">
  <h3>–®–∞–≥ 1: –í—ã–±–µ—Ä–∏—Ç–µ –ø–∞–ø–∫—É —Å PDF —Ñ–∞–π–ª–∞–º–∏</h3>
  <select id="sourceFolderList" class="input"></select>
  <button id="selectSourceFolderBtn" class="btn">üìÅ –í—ã–±—Ä–∞—Ç—å —ç—Ç—É –ø–∞–ø–∫—É</button>
</div>

<div id="fileSelector" class="hidden">
  <h3>–®–∞–≥ 2: –í—ã–±–µ—Ä–∏—Ç–µ PDF —Ñ–∞–π–ª –¥–ª—è —Å–∂–∞—Ç–∏—è</h3>
  <select id="fileList" class="input"></select>
  <button id="selectFileBtn" class="btn">üìÑ –í—ã–±—Ä–∞—Ç—å —ç—Ç–æ—Ç —Ñ–∞–π–ª</button>
</div>

<div id="targetFolderSelector" class="hidden">
  <h3>–®–∞–≥ 3: –ö—É–¥–∞ —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å —Å–∂–∞—Ç—ã–π —Ñ–∞–π–ª?</h3>
  <select id="targetFolderList" class="input"></select>
  <button id="selectTargetFolderBtn" class="btn">üíæ –í—ã–±—Ä–∞—Ç—å –ø–∞–ø–∫—É –Ω–∞–∑–Ω–∞—á–µ–Ω–∏—è</button>
</div>

<div id="status" class="status hidden"></div>
<button id="compressBtn" class="btn hidden" disabled>üì§ –°–∂–∞—Ç—å –∏ —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å –≤ MEGA</button>

<script type="module">
  import { Storage } from 'https://unpkg.com/megajs/dist/main.browser-es.mjs';

  const statusEl = document.getElementById('status');
  const loginBtn = document.getElementById('loginBtn');
  const emailInput = document.getElementById('emailInput');
  const passwordInput = document.getElementById('passwordInput');
  const loginForm = document.getElementById('loginForm');

  const folderSelector = document.getElementById('folderSelector');
  const sourceFolderList = document.getElementById('sourceFolderList');
  const selectSourceFolderBtn = document.getElementById('selectSourceFolderBtn');

  const fileSelector = document.getElementById('fileSelector');
  const fileList = document.getElementById('fileList');
  const selectFileBtn = document.getElementById('selectFileBtn');

  const targetFolderSelector = document.getElementById('targetFolderSelector');
  const targetFolderList = document.getElementById('targetFolderList');
  const selectTargetFolderBtn = document.getElementById('selectTargetFolderBtn');

  const compressBtn = document.getElementById('compressBtn');

  let storage = null;
  let selectedFile = null;
  let selectedSourceFolder = null;
  let selectedTargetFolder = null;
  let allFolders = [];
  let allFiles = [];

  // –í—Ö–æ–¥ –≤ MEGA
  loginBtn.onclick = async () => {
    const email = emailInput.value.trim();
    const password = passwordInput.value.trim();

    if (!email || !password) {
      alert('–í–≤–µ–¥–∏—Ç–µ email –∏ –ø–∞—Ä–æ–ª—å');
      return;
    }

    try {
      loginBtn.disabled = true;
      loginBtn.textContent = '‚è≥ –ü–æ–¥–∫–ª—é—á–∞–µ–º—Å—è...';
      statusEl.textContent = '–ü–æ–¥–∫–ª—é—á–∞–µ–º—Å—è –∫ MEGA...';
      statusEl.classList.remove('hidden');

      storage = await new Storage({ email, password }).ready;

      statusEl.textContent = '‚úÖ –£—Å–ø–µ—à–Ω–æ –ø–æ–¥–∫–ª—é—á–∏–ª–∏—Å—å! –ó–∞–≥—Ä—É–∂–∞–µ–º —Å—Ç—Ä—É–∫—Ç—É—Ä—É –ø–∞–ø–æ–∫...';

      // –ü–æ–ª—É—á–∞–µ–º –≤—Å–µ –ø–∞–ø–∫–∏
      allFolders = [];
      const filesArray = Object.values(storage.files);

      // –î–æ–±–∞–≤–ª—è–µ–º –∫–æ—Ä–Ω–µ–≤—É—é –ø–∞–ø–∫—É
      allFolders.push({ folder: storage.root, name: 'üìÅ –ö–æ—Ä–Ω–µ–≤–∞—è –ø–∞–ø–∫–∞ (Cloud Drive)', path: '/' });

      // –†–µ–∫—É—Ä—Å–∏–≤–Ω–æ —Å–æ–±–∏—Ä–∞–µ–º –≤—Å–µ –ø–∞–ø–∫–∏
      function collectFolders(folder, path = '') {
        if (folder.children) {
          for (const child of folder.children) {
            if (child.directory) {
              const fullPath = path + '/' + child.name;
              allFolders.push({ folder: child, name: child.name, path: fullPath });
              collectFolders(child, fullPath);
            }
          }
        }
      }

      collectFolders(storage.root, '');

      // –ó–∞–ø–æ–ª–Ω—è–µ–º —Å–ø–∏—Å–æ–∫ –ø–∞–ø–æ–∫-–∏—Å—Ç–æ—á–Ω–∏–∫–æ–≤
      sourceFolderList.innerHTML = '';
      targetFolderList.innerHTML = '';

      allFolders.forEach((item, index) => {
        const option1 = document.createElement('option');
        option1.value = index;
        option1.textContent = item.path;
        sourceFolderList.appendChild(option1);

        const option2 = document.createElement('option');
        option2.value = index;
        option2.textContent = item.path;
        targetFolderList.appendChild(option2);
      });

      loginForm.classList.add('hidden');
      folderSelector.classList.remove('hidden');
      statusEl.textContent = `‚úÖ –ù–∞–π–¥–µ–Ω–æ ${allFolders.length} –ø–∞–ø–æ–∫. –í—ã–±–µ—Ä–∏—Ç–µ –ø–∞–ø–∫—É —Å PDF —Ñ–∞–π–ª–∞–º–∏.`;

    } catch (error) {
      statusEl.textContent = `‚ùå –û—à–∏–±–∫–∞ –≤—Ö–æ–¥–∞: ${error.message}`;
      loginBtn.disabled = false;
      loginBtn.textContent = 'üîê –í–æ–π—Ç–∏ –≤ MEGA';
    }
  };

  // –®–∞–≥ 1: –í—ã–±–æ—Ä –ø–∞–ø–∫–∏-–∏—Å—Ç–æ—á–Ω–∏–∫–∞
  selectSourceFolderBtn.onclick = () => {
    const index = parseInt(sourceFolderList.value);
    selectedSourceFolder = allFolders[index].folder;

    // –°–æ–±–∏—Ä–∞–µ–º PDF —Ñ–∞–π–ª—ã –∏–∑ –≤—ã–±—Ä–∞–Ω–Ω–æ–π –ø–∞–ø–∫–∏
    allFiles = [];
    if (selectedSourceFolder.children) {
      for (const child of selectedSourceFolder.children) {
        if (!child.directory && child.name && child.name.toLowerCase().endsWith('.pdf')) {
          allFiles.push(child);
        }
      }
    }

    if (allFiles.length === 0) {
      statusEl.textContent = '‚ùå –í —ç—Ç–æ–π –ø–∞–ø–∫–µ –Ω–µ—Ç PDF —Ñ–∞–π–ª–æ–≤. –í—ã–±–µ—Ä–∏—Ç–µ –¥—Ä—É–≥—É—é –ø–∞–ø–∫—É.';
      return;
    }

    // –ó–∞–ø–æ–ª–Ω—è–µ–º —Å–ø–∏—Å–æ–∫ —Ñ–∞–π–ª–æ–≤
    fileList.innerHTML = '';
    allFiles.forEach((file, index) => {
      const option = document.createElement('option');
      option.value = index;
      const sizeMB = (file.size / 1024 / 1024).toFixed(2);
      option.textContent = `${file.name} (${sizeMB} –ú–ë)`;
      fileList.appendChild(option);
    });

    folderSelector.classList.add('hidden');
    fileSelector.classList.remove('hidden');
    statusEl.textContent = `‚úÖ –ù–∞–π–¥–µ–Ω–æ ${allFiles.length} PDF —Ñ–∞–π–ª–æ–≤ –≤ –ø–∞–ø–∫–µ "${allFolders[index].path}"`;
  };

  // –®–∞–≥ 2: –í—ã–±–æ—Ä —Ñ–∞–π–ª–∞
  selectFileBtn.onclick = () => {
    const index = parseInt(fileList.value);
    selectedFile = allFiles[index];

    const sizeMB = (selectedFile.size / 1024 / 1024).toFixed(2);
    statusEl.innerHTML = `‚úÖ –í—ã–±—Ä–∞–Ω —Ñ–∞–π–ª: <b>${selectedFile.name}</b> (${sizeMB} –ú–ë)`;

    fileSelector.classList.add('hidden');
    targetFolderSelector.classList.remove('hidden');
    statusEl.textContent = `‚úÖ –§–∞–π–ª –≤—ã–±—Ä–∞–Ω. –¢–µ–ø–µ—Ä—å –≤—ã–±–µ—Ä–∏—Ç–µ –ø–∞–ø–∫—É –¥–ª—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è —Å–∂–∞—Ç–æ–≥–æ —Ñ–∞–π–ª–∞.`;
  };

  // –®–∞–≥ 3: –í—ã–±–æ—Ä –ø–∞–ø–∫–∏ –Ω–∞–∑–Ω–∞—á–µ–Ω–∏—è
  selectTargetFolderBtn.onclick = () => {
    const index = parseInt(targetFolderList.value);
    selectedTargetFolder = allFolders[index].folder;

    targetFolderSelector.classList.add('hidden');
    compressBtn.classList.remove('hidden');
    compressBtn.disabled = false;

    const sizeMB = (selectedFile.size / 1024 / 1024).toFixed(2);
    statusEl.innerHTML = `‚úÖ –í—Å—ë –≥–æ—Ç–æ–≤–æ!<br>` +
      `–§–∞–π–ª: <b>${selectedFile.name}</b> (${sizeMB} –ú–ë)<br>` +
      `–°–æ—Ö—Ä–∞–Ω–∏—Ç—å –≤: <b>${allFolders[index].path}</b>`;
  };

  // –°–∂–∞—Ç–∏–µ –∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ
  compressBtn.onclick = async () => {
    if (!selectedFile) return;
    compressBtn.disabled = true;
    statusEl.textContent = '–°–∫–∞—á–∏–≤–∞–µ–º —Ñ–∞–π–ª –∏–∑ MEGA...';

    try {
      // –°–∫–∞—á–∏–≤–∞–µ–º —Ñ–∞–π–ª –∏–∑ MEGA
      const buffer = await selectedFile.downloadBuffer();
      const blob = new Blob([buffer], { type: 'application/pdf' });
      const originalSizeMB = (blob.size / 1024 / 1024).toFixed(2);

      // Backend URL –Ω–∞ Railway
      const backendUrl = 'https://mega-pdf-compressor-production.up.railway.app/compress';

      const formData = new FormData();
      formData.append('file', blob, selectedFile.name);
      formData.append('level', 'recommended'); // low, recommended, extreme

      statusEl.textContent = `–°–∂–∏–º–∞–µ–º —á–µ—Ä–µ–∑ iLovePDF (${originalSizeMB} –ú–ë)...`;
      const res = await fetch(backendUrl, { method: 'POST', body: formData });

      if (!res.ok) {
        const errorData = await res.json();
        throw new Error(errorData.error || `HTTP ${res.status}`);
      }

      const compressedBlob = await res.blob();
      const compressedSizeMB = (compressedBlob.size / 1024 / 1024).toFixed(2);

      // –ü–æ–ª—É—á–∞–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ —Å–∂–∞—Ç–∏–∏ –∏–∑ –∑–∞–≥–æ–ª–æ–≤–∫–æ–≤
      const reduction = res.headers.get('X-Reduction-Percent') || '?';

      statusEl.innerHTML = `‚úÖ –°–∂–∞—Ç–æ! ${originalSizeMB} –ú–ë ‚Üí ${compressedSizeMB} –ú–ë (‚àí${reduction}%)`;

      // –ó–∞–≥—Ä—É–∂–∞–µ–º –æ–±—Ä–∞—Ç–Ω–æ –≤ MEGA –≤ –≤—ã–±—Ä–∞–Ω–Ω—É—é –ø–∞–ø–∫—É
      statusEl.textContent = '–ó–∞–≥—Ä—É–∂–∞–µ–º —Å–∂–∞—Ç—ã–π —Ñ–∞–π–ª –≤ MEGA...';

      const compressedFileName = '[–°–∂–∞—Ç–æ] ' + selectedFile.name;
      const uploadedFile = await selectedTargetFolder.upload(compressedFileName, compressedBlob).complete;

      statusEl.innerHTML = `üéâ –ì–æ—Ç–æ–≤–æ!<br>` +
        `${originalSizeMB} –ú–ë ‚Üí ${compressedSizeMB} –ú–ë (‚àí${reduction}%)<br>` +
        `–°–æ—Ö—Ä–∞–Ω–µ–Ω–æ –∫–∞–∫: <b>${compressedFileName}</b>`;

      compressBtn.disabled = false;
      compressBtn.textContent = '‚úÖ –°–∂–∞—Ç—å –µ—â—ë –æ–¥–∏–Ω —Ñ–∞–π–ª';

      // –°–±—Ä–∞—Å—ã–≤–∞–µ–º –≤—ã–±–æ—Ä –¥–ª—è –Ω–æ–≤–æ–≥–æ —Ñ–∞–π–ª–∞
      compressBtn.onclick = () => {
        location.reload();
      };

    } catch (e) {
      statusEl.textContent = `‚ùå ${e.message}`;
      compressBtn.disabled = false;
    }
  };
</script>

</body>
</html>